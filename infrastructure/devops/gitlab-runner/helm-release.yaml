apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: gitlab-runner
  namespace: devops-tools
spec:
  interval: 60m
  chart:
    spec:
      chart: gitlab-runner
      version: "*"
      sourceRef:
        kind: HelmRepository
        name: gitlab
        namespace: flux-system
      interval: 12h
  values:
    rbac:
      create: true
      rules:
        - apiGroups: [ "" ]
          resources: [ "pods" ]
          verbs: [ "list", "get", "watch", "create", "delete" ]
        - apiGroups: [ "" ]
          resources: [ "pods/exec" ]
          verbs: [ "create" ]
        - apiGroups: [ "" ]
          resources: [ "pods/log" ]
          verbs: [ "get" ]
        - apiGroups: [ "" ]
          resources: [ "pods/attach" ]
          verbs: [ "list", "get", "create", "delete", "update" ]
        - apiGroups: [ "" ]
          resources: [ "secrets" ]
          verbs: [ "list", "get", "create", "delete", "update" ]
        - apiGroups: [ "" ]
          resources: [ "configmaps" ]
          verbs: [ "list", "get", "create", "delete", "update" ]
    gitlabUrl: https://gitlab.com
    concurrent: 4
    runners:
      config: |
        log_level = "debug"
        [[runners]]
          [runners.kubernetes]
            image = "ubuntu:latest"
            helper_image = "gitlab/gitlab-runner-helper:arm64-1278d3da"
            privileged = true
